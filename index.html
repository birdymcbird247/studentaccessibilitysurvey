<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Learning Preferences</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Custom styles to complement Tailwind */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc; /* Lighter gray for better contrast */
        }
        /* Style for the selectable cards */
        .preference-card {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        .preference-card.selected {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border-color: #2563eb; /* A slightly darker blue for better contrast */
            background-color: #eff6ff;
        }
        .preference-card.multi-selected {
             border-color: #2563eb;
             background-color: #eff6ff;
        }
        /* Enhanced focus ring for better visibility */
        .preference-card:focus-visible {
            outline: 2px solid transparent;
            outline-offset: 2px;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
        }
    </style>
</head>
<body class="antialiased text-gray-900">

    <!-- Main Container -->
    <div id="main-container" class="container mx-auto max-w-3xl p-4 sm:p-6 md:p-8">

        <!-- Header Section -->
        <div class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold">My Learning Preferences</h1>
            <p class="mt-2 text-lg text-gray-700">Help your teacher understand the best ways for you to learn!</p>
        </div>

        <!-- Survey Form -->
        <form id="preference-form" class="space-y-10">

            <!-- Student Info Section -->
            <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                <h2 id="student-info-heading" class="text-xl font-semibold mb-4">First, let's start with your name.</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="student-name" class="block text-md font-medium text-gray-700 mb-2">Your Name:</label>
                        <input type="text" id="student-name" name="student_name" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Enter your full name" required>
                    </div>
                    <div>
                        <label for="class-code" class="block text-md font-medium text-gray-700 mb-2">Class Code (optional):</label>
                        <input type="text" id="class-code" name="class_code" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Ask your teacher for this">
                    </div>
                </div>
            </div>

            <!-- Question 1: How I like to show my work -->
            <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                <h3 id="q1-heading" class="text-xl font-semibold mb-4">1. I show my best work when I can...</h3>
                <div id="q1-options" role="radiogroup" aria-labelledby="q1-heading" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <!-- Options will be dynamically generated by JS -->
                </div>
                <input type="hidden" id="q1-answer" name="q1_show_work" required>
            </div>

            <!-- Question 2: Helpful Tools -->
            <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                <h3 id="q2-heading" class="text-xl font-semibold mb-4">2. What tools help you learn? (Choose all that help)</h3>
                <div id="q2-options" role="group" aria-labelledby="q2-heading" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <!-- Options will be dynamically generated by JS -->
                </div>
                <input type="hidden" id="q2-answer" name="q2_helpful_tools">
            </div>

            <!-- Question 3: Working Style -->
            <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                <h3 id="q3-heading" class="text-xl font-semibold mb-4">3. I do my best thinking when I work...</h3>
                <div id="q3-options" role="radiogroup" aria-labelledby="q3-heading" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                     <!-- Options will be dynamically generated by JS -->
                </div>
                <input type="hidden" id="q3-answer" name="q3_working_style" required>
            </div>

            <!-- Question 4: Open-ended -->
            <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                <h3 id="q4-heading" class="text-xl font-semibold mb-4">4. Is there anything else your teacher should know?</h3>
                <label for="q4-other-info" class="sr-only">Is there anything else your teacher should know?</label>
                <textarea id="q4-other-info" name="q4_other_info" rows="4" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="For example: 'I need extra time to read instructions' or 'I like to listen to quiet music while I work.'" aria-labelledby="q4-heading"></textarea>
            </div>


            <!-- Submission Button -->
            <div class="flex justify-center">
                <button type="submit" id="submit-button" class="bg-blue-600 text-white font-bold py-4 px-10 rounded-lg shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all duration-200 ease-in-out text-lg">
                    Send to My Teacher
                </button>
            </div>
        </form>

        <!-- Thank You Message -->
        <div id="thank-you-message" class="hidden text-center bg-green-100 border-l-4 border-green-500 text-green-800 p-8 rounded-lg shadow-md">
            <h2 class="text-3xl font-bold">Thank You!</h2>
            <p class="mt-2 text-xl">Your preferences have been sent to your teacher.</p>
        </div>

    </div>

    <!-- Firebase and App Logic -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = typeof __firebase_config !== 'undefined'
            ? JSON.parse(__firebase_config)
            : {
                apiKey: "YOUR_API_KEY",
                authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
                projectId: "YOUR_PROJECT_ID",
                storageBucket: "YOUR_PROJECT_ID.appspot.com",
                messagingSenderId: "YOUR_SENDER_ID",
                appId: "YOUR_APP_ID"
              };
        // --- END OF FIREBASE CONFIGURATION ---

        let db, auth;

        // --- Data for the preference cards ---
        const optionsData = {
            q1: [
                { id: 'write', text: 'Write', icon: `<svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mx-auto mb-2" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>` },
                { id: 'speak', text: 'Speak', icon: `<svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mx-auto mb-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.083-3.083A6.983 6.983 0 012 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM4.417 11.583A5.013 5.013 0 004 10c0-2.21 2.239-4 5-4s5 1.79 5 4-2.239 4-5 4a5.006 5.006 0 00-2.583-.683A.5.5 0 006 13.5v.583z" clip-rule="evenodd" /></svg>` },
                { id: 'draw', text: 'Draw', icon: `<svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mx-auto mb-2" viewBox="0 0 20 20" fill="currentColor"><path d="M15 10a1 1 0 11-2 0 1 1 0 012 0zM3 5a2 2 0 012-2h10a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V5zm2-2a1 1 0 00-1 1v10a1 1 0 001 1h10a1 1 0 001-1V5a1 1 0 00-1-1H5z" /><path d="M6 11a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1z" /></svg>` },
                { id: 'build', text: 'Build', icon: `<svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mx-auto mb-2" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg>` }
            ],
            q2: [
                { id: 'listening_tools', text: 'Listening Tools', icon: `<svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mx-auto mb-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H4a1 1 0 01-1-1V8a1 1 0 011-1h.586l3.707-3.707a1 1 0 011.09-.217zM14.25 5.75a.75.75 0 000 1.06l.94.94a2.5 2.5 0 010 3.536l-.94.94a.75.75 0 101.06 1.06l.94-.94a4 4 0 000-5.656l-.94-.94a.75.75 0 00-1.06 0z" clip-rule="evenodd" /></svg>` },
                { id: 'quiet_space', text: 'Quiet Space', icon: `<svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mx-auto mb-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1.333a1 1 0 01-2 0V3a1 1 0 011-1zm6.95 3.95a1 1 0 010 1.414l-.99.99a1 1 0 11-1.414-1.414l.99-.99a1 1 0 011.414 0zM3.05 7.364a1 1 0 111.414-1.414l.99.99a1 1 0 11-1.414 1.414l-.99-.99zM10 18a1 1 0 01-1-1v-1.333a1 1 0 112 0V17a1 1 0 01-1-1zm-6.95-3.95a1 1 0 010-1.414l.99-.99a1 1 0 111.414 1.414l-.99.99a1 1 0 01-1.414 0zM16.95 12.636a1 1 0 11-1.414 1.414l-.99-.99a1 1 0 111.414-1.414l.99.99zM10 12a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg>` },
                { id: 'trackpad_mouse', text: 'Trackpad / Mouse', icon: `<svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mx-auto mb-2" viewBox="0 0 20 20" fill="currentColor"><rect x="4" y="4" width="12" height="12" rx="2" /></svg>` },
                { id: 'voice_text_tools', text: 'Voice & Text Tools', icon: `<svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mx-auto mb-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8h-1a6 6 0 11-5.93 5.98A5.98 5.98 0 0111 14.93zM9 8a1 1 0 012 0v2a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>` }
            ],
            q3: [
                { id: 'alone', text: 'By Myself', icon: `<svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mx-auto mb-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>` },
                { id: 'partner', text: 'With a Partner', icon: `<svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mx-auto mb-2" viewBox="0 0 20 20" fill="currentColor"><path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zm-2 5a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0011 11H9zM10 6a3 3 0 116 0 3 3 0 01-6 0z" /></svg>` },
                { id: 'group', text: 'In a Small Group', icon: `<svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mx-auto mb-2" viewBox="0 0 20 20" fill="currentColor"><path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z" /></svg>` }
            ]
        };

        // --- Function to create and render preference cards ---
        function createCard(option, questionId, isMultiSelect = false) {
            const card = document.createElement('div');
            card.className = 'preference-card text-center p-4 bg-white border-2 border-gray-200 rounded-lg shadow-sm hover:shadow-lg hover:border-blue-400 focus:outline-none';
            card.dataset.value = option.id;
            card.setAttribute('tabindex', '0'); // Make it focusable
            
            if (isMultiSelect) {
                card.setAttribute('role', 'checkbox');
                card.setAttribute('aria-checked', 'false');
            } else {
                card.setAttribute('role', 'radio');
                card.setAttribute('aria-checked', 'false');
            }
            
            card.innerHTML = `${option.icon}<p class="font-semibold text-gray-700">${option.text}</p>`;
            
            const handleClick = () => {
                const hiddenInput = document.getElementById(`${questionId}-answer`);
                if (isMultiSelect) {
                    const isSelected = card.classList.toggle('multi-selected');
                    card.setAttribute('aria-checked', isSelected);
                    const selectedValues = Array.from(document.querySelectorAll(`#${questionId}-options .multi-selected`)).map(el => el.dataset.value);
                    hiddenInput.value = selectedValues.join(',');
                } else {
                    document.querySelectorAll(`#${questionId}-options .preference-card`).forEach(c => {
                        c.classList.remove('selected');
                        c.setAttribute('aria-checked', 'false');
                    });
                    card.classList.add('selected');
                    card.setAttribute('aria-checked', 'true');
                    hiddenInput.value = option.id;
                }
            };

            card.addEventListener('click', handleClick);
            card.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' || event.key === ' ') {
                    event.preventDefault(); // Prevent scrolling on spacebar press
                    handleClick();
                }
            });

            return card;
        }

        // --- Main App Function ---
        async function main() {
            // Render the cards
            const q1Container = document.getElementById('q1-options');
            optionsData.q1.forEach(opt => q1Container.appendChild(createCard(opt, 'q1')));

            const q2Container = document.getElementById('q2-options');
            optionsData.q2.forEach(opt => q2Container.appendChild(createCard(opt, 'q2', true)));

            const q3Container = document.getElementById('q3-options');
            optionsData.q3.forEach(opt => q3Container.appendChild(createCard(opt, 'q3')));

            // Initialize Firebase
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                await signInAnonymously(auth);
                console.log("Anonymous authentication successful.");
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                document.getElementById('submit-button').disabled = true;
                document.getElementById('submit-button').textContent = 'Connection Error';
            }

            // Attach form submission listener
            document.getElementById('preference-form').addEventListener('submit', handleFormSubmit);
        }

        // --- Form Submission Handler ---
        async function handleFormSubmit(event) {
            event.preventDefault();
            const submitButton = document.getElementById('submit-button');
            submitButton.disabled = true;
            submitButton.textContent = 'Sending...';

            const studentName = document.getElementById('student-name').value;
            if (!studentName) {
                alert("Please enter your name.");
                submitButton.disabled = false;
                submitButton.textContent = 'Send to My Teacher';
                return;
            }

            const formData = new FormData(event.target);
            const studentPreferences = {};
            for (let [key, value] of formData.entries()) {
                studentPreferences[key] = value;
            }
            studentPreferences.submittedAt = serverTimestamp();
            
            const studentDocId = studentName.trim().toLowerCase().replace(/\s+/g, '-');

            try {
                const docRef = doc(db, `studentPreferences/${studentDocId}`);
                await setDoc(docRef, studentPreferences, { merge: true });

                console.log("Preferences saved for student:", studentDocId);
                
                document.getElementById('preference-form').classList.add('hidden');
                document.getElementById('thank-you-message').classList.remove('hidden');

            } catch (error) {
                console.error("Error saving preferences to Firestore: ", error);
                alert("There was an error sending your preferences. Please try again.");
                submitButton.disabled = false;
                submitButton.textContent = 'Send to My Teacher';
            }
        }
        
        // Run the app
        main();
    </script>
</body>
</html>
